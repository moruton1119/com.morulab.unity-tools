name: Publish VPM Package

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Pack Package
        run: |
          zip -r "com.moruton.blm-local-connector-${{ steps.version.outputs.VERSION }}.zip" . -x ".git/*" ".github/*" ".vscode/*" "Tests/*" "obj/*"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: "com.moruton.blm-local-connector-${{ steps.version.outputs.VERSION }}.zip"
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}

      - name: Install vrc-get
        run: |
          curl -sL https://github.com/anatawa12/vrc-get/releases/latest/download/vrc-get-x86_64-unknown-linux-musl -o vrc-get
          chmod +x vrc-get

      - name: Update VPM Repository
        run: |
          ./vrc-get repo add-package package.json --repo-json index.json --url https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/com.moruton.blm-local-connector-${{ steps.version.outputs.VERSION }}.zip

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: true
